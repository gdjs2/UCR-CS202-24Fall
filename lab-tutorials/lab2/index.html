<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Zhaoqi Xiao">
        <link rel="canonical" href="http://gdjs2.cn/UCR-CS202-24Fall/lab-tutorials/lab2/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Lab 2 - Scheduler, Lottery and Stride - CS202 Advanced Operating System - Lab Session</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">CS202 Advanced Operating System - Lab Session</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">CS202 - Advanced Operating System - Lab Session - 24 Fall</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Lab tutorials</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../debug/" class="dropdown-item">Debugging Tips</a>
</li>
                                    
<li>
    <a href="../lab1/" class="dropdown-item">Lab 1 - System Call Implementation</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Lab 2 - Scheduler, Lottery and Stride</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../lab1/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" class="nav-link disabled">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#lab-2-scheduler-lottery-and-stride" class="nav-link">Lab 2 - Scheduler, Lottery and Stride</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#before-start" class="nav-link">Before Start</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#pull-the-repo" class="nav-link">Pull the Repo</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#compile-and-run" class="nav-link">Compile and Run</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="lab-2-scheduler-lottery-and-stride">Lab 2 - Scheduler, Lottery and Stride</h1>
<h2 id="before-start">Before Start</h2>
<p>Take a look at <a href="https://github.com/gdjs2/xv6-riscv-UCR-CS202-Fall24">our project repo</a>. We have a new <a href="https://github.com/gdjs2/xv6-riscv-UCR-CS202-Fall24/tree/scheduler-lab">scheduler-lab branch</a> published. In this lab, you need implement your work based on this branch. </p>
<p>Also, get overall idea for these two scheduling strategy:</p>
<ul>
<li><a href="https://dl.acm.org/doi/pdf/10.5555/1267638.1267639">Lottery Scheduling</a></li>
<li><a href="https://web.eecs.umich.edu/~prabal/teaching/eecs582-w13/readings/stride.pdf">Stride Scheduling</a></li>
</ul>
<h2 id="pull-the-repo">Pull the Repo</h2>
<p>Clone the repo to your local machine. </p>
<pre><code class="language-bash">$ git clone https://github.com/gdjs2/xv6-riscv-UCR-CS202-Fall24.git
</code></pre>
<p>Change directory and checkout to scheduler-lab branch. </p>
<pre><code class="language-bash">$ git checkout scheduler-lab
</code></pre>
<p>If you receive error like:</p>
<pre><code class="language-bash">fatal: detected dubious ownership in repository at...
</code></pre>
<p>just follow the instruction mark the directory as safe. </p>
<p>Let's first see what has been done for our project.</p>
<h3 id="makefile">Makefile</h3>
<p>In <code>Makefile</code>, we have four mofidifcations:</p>
<ol>
<li>Add a source file and objective file random.o, which is a <a href="https://en.wikipedia.org/wiki/Linear_congruential_generator">Linear congruential generator (LCG)</a> for generating random numbers in lottery scheduler.</li>
<li>Add a macro deciding which scheduler to use in compiling.</li>
<li>Add a user space program to test different schedulers.</li>
<li>Change the cpu counts to one. (why we need do this?)</li>
</ol>
<pre><code class="language-diff">diff --git a/Makefile b/Makefile
index f8c820e..b2ce8c0 100644
--- a/Makefile
+++ b/Makefile
@@ -28,7 +28,8 @@ OBJS = \
   $K/sysfile.o \
   $K/kernelvec.o \
   $K/plic.o \
-  $K/virtio_disk.o
+  $K/virtio_disk.o \
+  $K/random.o

 # riscv64-unknown-elf- or riscv64-linux-gnu-
 # perhaps in /opt/riscv/bin
@@ -78,6 +79,13 @@ ifneq ($(shell $(CC) -dumpspecs 2&gt;/dev/null | grep -e '[^f]nopie'),)
 CFLAGS += -fno-pie -nopie
 endif

+# Add lottery and stride scheduler
+ifeq ($(SCHEDULER), LOTTERY)
+   CFLAGS += -DSCHEDULER=LOTTERY
+else ifeq ($(SCHEDULER), STRIDE)
+   CFLAGS += -DSCHEDULER=STRIDE
+endif
+
 LDFLAGS = -z max-page-size=4096

 $K/kernel: $(OBJS) $K/kernel.ld $U/initcode
@@ -139,6 +147,7 @@ UPROGS=\
    $U/_grind\
    $U/_wc\
    $U/_zombie\
+   $U/_test_scheduler\

 fs.img: mkfs/mkfs README $(UPROGS)
    mkfs/mkfs fs.img README $(UPROGS)
@@ -160,7 +169,7 @@ QEMUGDB = $(shell if $(QEMU) -help | grep -q '^-gdb'; \
    then echo &quot;-gdb tcp::$(GDBPORT)&quot;; \
    else echo &quot;-s -p $(GDBPORT)&quot;; fi)
 ifndef CPUS
-CPUS := 3
+CPUS := 1
 endif

 QEMUOPTS = -machine virt -bios none -kernel $K/kernel -m 128M -smp $(CPUS) -nographic
</code></pre>
<h3 id="kerneldefsh">/kernel/defs.h</h3>
<p>In <code>/kernel/defs.h</code>, we have two modifications:
1. Add declaration for two kernel functions. <code>void proc_set_tickets(int)</code> is for setting tickets for current process and <code>int getticks(int pid)</code> is for getting ticks spent on particular process specified by <code>pid</code>.
2. Add function interfaces for <code>random.o</code>-<code>uint random(void)</code> for generating random numbers and <code>void srand(uint64)</code> for specifying the seed of randomization. </p>
<pre><code class="language-diff">diff --git a/kernel/defs.h b/kernel/defs.h
index d1b6bb9..03b3d6c 100644
--- a/kernel/defs.h
+++ b/kernel/defs.h
@@ -106,6 +106,8 @@ void            yield(void);
 int             either_copyout(int user_dst, uint64 dst, void *src, uint64 len);
 int             either_copyin(void *dst, int user_src, uint64 src, uint64 len);
 void            procdump(void);
+void            proc_set_tickets(int);
+int             getticks(int pid);

 // swtch.S
 void            swtch(struct context*, struct context*);
@@ -187,3 +189,7 @@ void            virtio_disk_intr(void);

 // number of elements in fixed-size array
 #define NELEM(x) (sizeof(x)/sizeof((x)[0]))
+
+// random.c
+uint            random(void);
+void            srand(uint64);
\ No newline at end of file
</code></pre>
<h3 id="kernelparamh">/kernel/param.h</h3>
<p>In <code>/kernel/param.h</code>, we defined several constants for schedulers:</p>
<ol>
<li><code>STRIDE1</code>: the total stride in stride scheduler, $2^{16}$ by default</li>
<li><code>DEFAULT_TICKS</code>: the default <strong>TICKETS</strong> for process, $2^{10}=1024$ by default.</li>
<li><code>LOTTERY</code> and <code>STRIDE</code>: variables for conditional compilation.</li>
</ol>
<pre><code class="language-diff">diff --git a/kernel/param.h b/kernel/param.h
index 80ec6d3..f998f5d 100644
--- a/kernel/param.h
+++ b/kernel/param.h
@@ -12,4 +12,7 @@
 #define FSSIZE       2000  // size of file system in blocks
 #define MAXPATH      128   // maximum file path name
 #define USERSTACK    1     // user stack pages
-
+#define STRIDE1      (1&lt;&lt;16)     // stride value for stride scheduling
+#define DEFAULT_TICKS (1&lt;&lt;10) // default time slice for stride scheduling
+#define LOTTERY      1 // lottery scheduling
+#define STRIDE       2 // stride scheduling
</code></pre>
<h3 id="kernelprocc">/kernel/proc.c</h3>
<p>This is the most complex part and what you need to do is implementing two scheduler functions in this file, referring to <strong>TODO</strong> symbols. </p>
<h4 id="new-member-vars">New Member Vars</h4>
<p>We have four member variables defined in <code>struct proc</code> for schedulers-<code>tickets</code>, <code>stride</code>, <code>pass</code> and <code>ticks</code>. For their definition and usage, refer to the <a href="#before-start">papers</a>. </p>
<pre><code class="language-diff">--- a/kernel/proc.c
+++ b/kernel/proc.c
@@ -124,6 +124,10 @@ allocproc(void)
 found:
   p-&gt;pid = allocpid();
   p-&gt;state = USED;
+  p-&gt;tickets = DEFAULT_TICKS;
+  p-&gt;stride = STRIDE1 / p-&gt;tickets;
+  p-&gt;pass = p-&gt;stride;
+  p-&gt;ticks = 0;

   // Allocate a trapframe page.
   if((p-&gt;trapframe = (struct trapframe *)kalloc()) == 0){
@@ -169,6 +173,10 @@ freeproc(struct proc *p)
   p-&gt;killed = 0;
   p-&gt;xstate = 0;
   p-&gt;state = UNUSED;
+  p-&gt;tickets = 0;
+  p-&gt;stride = 0;
+  p-&gt;pass = 0;
+  p-&gt;ticks = 0;
 }
</code></pre>
<h4 id="scheduler-part">Scheduler Part</h4>
<p><strong>WHAT YOU NEED TO DO</strong> in this project is finishing the two <code>scheduler()</code> functions in this file and test them by provided user space program.</p>
<p>The original <code>void scheduler(void)</code> function is a Round Robin (RR) scheduling. </p>
<pre><code class="language-c">void
scheduler(void)
{
  struct proc *p;
  struct cpu *c = mycpu();

  c-&gt;proc = 0;
  for(;;){
    // The most recent process to run may have had interrupts
    // turned off; enable them to avoid a deadlock if all
    // processes are waiting.
    ...
    }
  }
}
</code></pre>
<p>The outer <code>for(;;)</code> loop will be launched when each cpu starts. Therefore, in the default implementation, you can find that the function keeps finding the available (i.e., <code>RUNNABLE</code>) process and run it whenever the scheduler finds one. This is known as RR scheduling. It's not hard to imagine that, the processes will be executed evenly and they will have almost the same execution time. </p>
<pre><code class="language-c">acquire(&amp;p-&gt;lock);
...
release(&amp;p-&gt;lock);
</code></pre>
<p>Acquire and release the process lock when you need to access/modify the members in structure <code>p</code> to avoid consistency issues. </p>
<p><code>intr_on()</code> is used for enabling the interrupts in OS.</p>
<p><code>asm volatile("wfi")</code> is used for inserting a assembly language <code>wfi</code>, which puts current CPU to idle and waiting till next interrput. </p>
<pre><code class="language-diff"> @@ -441,6 +449,7 @@ wait(uint64 addr)
 //  - swtch to start running that process.
 //  - eventually that process transfers control
 //    via swtch back to the scheduler.
+#if !defined(SCHEDULER) || (SCHEDULER != LOTTERY &amp;&amp; SCHEDULER != STRIDE)
 void
 scheduler(void)
 {
@@ -464,6 +473,7 @@ scheduler(void)
         p-&gt;state = RUNNING;
         c-&gt;proc = p;
         swtch(&amp;c-&gt;context, &amp;p-&gt;context);
+        ++p-&gt;ticks;  // Increment the tick count for the process.

         // Process is done running for now.
         // It should have changed its p-&gt;state before coming back.
@@ -480,6 +490,26 @@ scheduler(void)
   }
 }

+#elif SCHEDULER == LOTTERY
+/**
+ * TODO: Implement the lottery scheduler.
+ */
+void
+scheduler(void)
+{
+
+}
+#elif SCHEDULER == STRIDE
+/**
+ * TODO: Implement the stride scheduler.
+ */
+void
+scheduler(void)
+{
+
+}
+#endif
+
 // Switch to scheduler.  Must hold only p-&gt;lock
 // and have changed proc-&gt;state. Saves and restores
 // intena because intena is a property of this
@@ -693,3 +723,24 @@ procdump(void)
     printf(&quot;\n&quot;);
   }
 }
+
</code></pre>
<h4 id="two-kernel-functions">Two Kernel Functions</h4>
<p>Two kernel functions implementation for setting tickets and getting ticks, referring <a href="#kerneldefsh">here</a> for details.</p>
<pre><code class="language-diff">+void proc_set_tickets(int tickets) {
+  struct proc *p = myproc();
+  acquire(&amp;p-&gt;lock);
+  p-&gt;tickets = tickets;
+  p-&gt;stride = STRIDE1 / p-&gt;tickets;
+  release(&amp;p-&gt;lock);
+}
+
+int getticks(int pid) {
+  struct proc *p;
+  for (p = proc; p &lt; &amp;proc[NPROC]; p++) {
+    acquire(&amp;p-&gt;lock);
+    if (p-&gt;pid == pid) {
+      release(&amp;p-&gt;lock);
+      return p-&gt;ticks;
+    }
+    release(&amp;p-&gt;lock);
+  }
+  return -1;
+}
\ No newline at end of file
</code></pre>
<h3 id="kernelproch">/kernel/proc.h</h3>
<p>Add necessary attributes for structure <code>struct proc</code>, refer <a href="#new-member-vars">here</a> for details.</p>
<pre><code class="language-diff">diff --git a/kernel/proc.h b/kernel/proc.h
index d021857..d5e5fc5 100644
--- a/kernel/proc.h
+++ b/kernel/proc.h
@@ -91,6 +91,10 @@ struct proc {
   int killed;                  // If non-zero, have been killed
   int xstate;                  // Exit status to be returned to parent's wait
   int pid;                     // Process ID
+  uint tickets;
+  uint stride;
+  uint pass;
+  uint ticks;

   // wait_lock must be held when using this:
   struct proc *parent;         // Parent process
</code></pre>
<h3 id="kernelrandomc">/kernel/random.c</h3>
<p>Source file for random number generation. You would use them in lottery scheduling. Refer <a href="#kerneldefsh">here</a> for details.</p>
<pre><code class="language-diff">diff --git a/kernel/random.c b/kernel/random.c
new file mode 100644
index 0000000..53334b0
--- /dev/null
+++ b/kernel/random.c
@@ -0,0 +1,12 @@
+#include &quot;types.h&quot;
+
+static uint64 seed = 1;
+
+uint random(void) {
+    seed = seed * 6364136223846793005ULL + 1;
+    return (seed &gt;&gt; 32) &amp; 0x7fffffff;
+}
+
+void srand(uint64 new_seed) {
+    seed = new_seed;
+}
\ No newline at end of file
</code></pre>
<h3 id="kernelsyscallc">/kernel/syscall.c</h3>
<p>Mandatory system calls definition, you have learned them in Lab 1.</p>
<pre><code class="language-diff">diff --git a/kernel/syscall.c b/kernel/syscall.c
index ed65409..217a31b 100644
--- a/kernel/syscall.c
+++ b/kernel/syscall.c
@@ -101,6 +101,8 @@ extern uint64 sys_unlink(void);
 extern uint64 sys_link(void);
 extern uint64 sys_mkdir(void);
 extern uint64 sys_close(void);
+extern uint64 sys_settickets(void);
+extern uint64 sys_getticks(void);

 // An array mapping syscall numbers from syscall.h
 // to the function that handles the system call.
@@ -126,6 +128,8 @@ static uint64 (*syscalls[])(void) = {
 [SYS_link]    sys_link,
 [SYS_mkdir]   sys_mkdir,
 [SYS_close]   sys_close,
+[SYS_settickets]  sys_settickets,
+[SYS_getticks]    sys_getticks,
 };

 void
</code></pre>
<h3 id="kernelsyscallh">/kernel/syscall.h</h3>
<p>Same to above. </p>
<pre><code class="language-diff">diff --git a/kernel/syscall.h b/kernel/syscall.h
index bc5f356..19fc543 100644
--- a/kernel/syscall.h
+++ b/kernel/syscall.h
@@ -1,22 +1,24 @@
 // System call numbers
-#define SYS_fork    1
-#define SYS_exit    2
-#define SYS_wait    3
-#define SYS_pipe    4
-#define SYS_read    5
-#define SYS_kill    6
-#define SYS_exec    7
-#define SYS_fstat   8
-#define SYS_chdir   9
-#define SYS_dup    10
-#define SYS_getpid 11
-#define SYS_sbrk   12
-#define SYS_sleep  13
-#define SYS_uptime 14
-#define SYS_open   15
-#define SYS_write  16
-#define SYS_mknod  17
-#define SYS_unlink 18
-#define SYS_link   19
-#define SYS_mkdir  20
-#define SYS_close  21
+#define SYS_fork        1
+#define SYS_exit        2
+#define SYS_wait        3
+#define SYS_pipe        4
+#define SYS_read        5
+#define SYS_kill        6
+#define SYS_exec        7
+#define SYS_fstat       8
+#define SYS_chdir       9
+#define SYS_dup         10
+#define SYS_getpid      11
+#define SYS_sbrk        12
+#define SYS_sleep       13
+#define SYS_uptime      14
+#define SYS_open        15
+#define SYS_write       16
+#define SYS_mknod       17
+#define SYS_unlink      18
+#define SYS_link        19
+#define SYS_mkdir       20
+#define SYS_close       21
+#define SYS_settickets  22
+#define SYS_getticks    23
</code></pre>
<h3 id="kernelsysprocc">/kernel/sysproc.c</h3>
<p>System call implementations. </p>
<pre><code class="language-diff">diff --git a/kernel/sysproc.c b/kernel/sysproc.c
index 3b4d5bd..e53385f 100644
--- a/kernel/sysproc.c
+++ b/kernel/sysproc.c
@@ -91,3 +91,23 @@ sys_uptime(void)
   release(&amp;tickslock);
   return xticks;
 }
+
+uint64
+sys_settickets(void)
+{
+  int tickets;
+  argint(0, &amp;tickets);
+  if (tickets &lt; 1) {
+    return -1;
+  }
+  proc_set_tickets(tickets);
+  return 0;
+}
+
+uint64
+sys_getticks(void)
+{
+  int pid;
+  argint(0, &amp;pid);
+  return getticks(pid);
+}
\ No newline at end of file
</code></pre>
<h3 id="useruserh">/user/user.h</h3>
<p>The system call interface in user space.</p>
<pre><code class="language-diff">diff --git a/user/user.h b/user/user.h
index f16fe27..f09d85b 100644
--- a/user/user.h
+++ b/user/user.h
@@ -22,6 +22,8 @@ int getpid(void);
 char* sbrk(int);
 int sleep(int);
 int uptime(void);
+int settickets(int);
+int getticks(int);

 // ulib.c
 int stat(const char*, struct stat*);
diff --git a/user/usys.pl b/user/usys.pl
index 01e426e..86af7cb 100755
--- a/user/usys.pl
+++ b/user/usys.pl
@@ -36,3 +36,5 @@ entry(&quot;getpid&quot;);
 entry(&quot;sbrk&quot;);
 entry(&quot;sleep&quot;);
 entry(&quot;uptime&quot;);
+entry(&quot;settickets&quot;);
+entry(&quot;getticks&quot;);
\ No newline at end of file
</code></pre>
<h3 id="usertest_schedulerc">/user/test_scheduler.c</h3>
<p>This is the test program in user space for you testing schedulers' behavior.</p>
<p>There are several arguments for this program. </p>
<ol>
<li><code>SLEEP_TIME</code>: the time in ticks you want to make the parent process to sleep.</li>
<li><code>N_PROC</code>: the count of processes you want to run for testing.</li>
<li><code>TICKETN</code>: the ticket number for different process.</li>
</ol>
<p>This parent process does three things:</p>
<ol>
<li>Create <code>N_PROC</code> child processes.</li>
<li>Sleep for <code>SLEEP_TIME</code> ticks.</li>
<li>KILL all child and output their execution time (in ticks). </li>
</ol>
<p>All child processes do two things:</p>
<ol>
<li>Set tickets for itself.</li>
<li>Do a infinite <code>while(1)</code> loop.</li>
</ol>
<p>The expected behavior of this program is that, the parent process would output ticks for each child process and the ticks matches your scheduling strategy. Specifically, for original scheduler it should output almost same ticks for each process no matter what tickets they have and the ticks should be inversely proportinal to the number of tickets. </p>
<pre><code class="language-diff">diff --git a/user/test_scheduler.c b/user/test_scheduler.c
new file mode 100644
index 0000000..23dd138
--- /dev/null
+++ b/user/test_scheduler.c
@@ -0,0 +1,49 @@
+#include &quot;kernel/types.h&quot;
+#include &quot;user/user.h&quot;
+
+const int MAX_N_PROC = 1 &lt;&lt; 5;
+const int MAX_TICKETS = 1 &lt;&lt; 10;
+
+int main(int argc, char **argv) {
+    if (argc &lt; 4) {
+        printf(&quot;Usage: %s [SLEEP_TIME in ms] [N_PROC] [TICKET1] [TICKET2]...\n&quot;, argv[0]);
+        exit(-1);
+    }
+    int sleep_time = atoi(argv[1]);
+    int n_proc = atoi(argv[2]);
+    if (n_proc &gt; MAX_N_PROC) {
+        printf(&quot;Error: Maximum number of processes is %d (%d received)\n&quot;, MAX_N_PROC, n_proc);
+        exit(-1);
+    }
+    int tickets[MAX_N_PROC];
+    for (int i = 0; i &lt; n_proc; i++) {
+        tickets[i] = atoi(argv[i + 3]);
+        if (tickets[i] &lt; 1 || tickets[i] &gt; MAX_TICKETS) {
+            printf(&quot;Error: Ticket value must be between 1 and %d (%d received)\n&quot;, MAX_TICKETS, tickets[i]);
+            exit(-1);
+        }
+    }
+
+    int *childs = malloc(n_proc * sizeof(int));
+    for (int i = 0; i &lt; n_proc; ++i) {
+        int pid = fork();
+        if (pid == 0) {
+            // Child process
+            settickets(tickets[i]);
+            while (1) ; // Infinite loop to keep the child process running
+        } else if (pid &gt; 0) {
+            // Parent process
+            childs[i] = pid;
+            printf(&quot;Created child process with PID: %d and tickets: %d\n&quot;, pid, tickets[i]);
+        } else {
+            printf(&quot;Error: Fork failed\n&quot;);
+            exit(-1);
+        }
+    }
+    sleep(sleep_time);
+    for (int i = 0; i &lt; n_proc; ++i) {
+        printf(&quot;Child PID: %d, ticks spent: %d\n&quot;, childs[i], getticks(childs[i]));
+        kill(childs[i]);
+    }
+    return 0;
+}
\ No newline at end of file
</code></pre>
<h2 id="compile-and-run">Compile and Run</h2>
<p>After you are familiar to the source code modification, you can now run the test program for default RR scheduler. </p>
<pre><code class="language-bash">$ make qemu
riscv64-linux-gnu-gcc    -c -o kernel/entry.o kernel/entry.S
...
qemu-system-riscv64 -machine virt -bios none -kernel kernel/kernel -m 128M -smp 1 -nographic -global virtio-mmio.force-legacy=false -drive file=fs.img,if=none,format=raw,id=x0 -device virtio-blk-device,drive=x0,bus=virtio-mmio-bus.0

xv6 kernel is booting

init: starting sh
$ 
</code></pre>
<p>Run our test program by:</p>
<pre><code class="language-bash">$ ./test_scheduler 100 3 1024 512 256
</code></pre>
<p>In this test, we run 3 child processes and they have 1024, 512 and 256 tickets seperately. The expected output for this test should be closely equal ticks. The program may wait for several seconds or minutes to finish based on your CPU speed. </p>
<p>If you see the output like following, you are ready to write your own scheduler!</p>
<pre><code class="language-bash">$ ./test_scheduler 100 3 1024 512 256
Created child process with PID: 4 and tickets: 1024
Created child process with PID: 5 and tickets: 512
Created child process with PID: 6 and tickets: 256
Child PID: 4, ticks spent: 34
Child PID: 5, ticks spent: 34
Child PID: 6, ticks spent: 34
</code></pre>
<p>When you finish your lottery and stride scheduler, you can compile them by:</p>
<pre><code class="language-bash">$ make clean
$ make SCHEDULER=LOTTERY qemu
</code></pre>
<p>and</p>
<pre><code class="language-bash">$ make clean
$ make SCHEDULER=STRIDE qemu
</code></pre>
<p><strong>REMEMBER TO CLEAN</strong> whenver you want to re-compile your code. </p>
<p>The expect output for lottery should be:</p>
<pre><code class="language-bash">$ ./test_scheduler 100 3 1024 512 256
Created child process with PID: 4 and tickets: 1024
Created child process with PID: 5 and tickets: 512
Created child process with PID: 6 and tickets: 256
Child PID: 4, ticks spent: 56
Child PID: 5, ticks spent: 32
Child PID: 6, ticks spent: 14
$ ./test_scheduler 100 3 1024 512 256
Created child process with PID: 9 and tickets: 1024
Created child process with PID: 10 and tickets: 512
Created child process with PID: 11 and tickets: 256
Child PID: 9, ticks spent: 60
Child PID: 10, ticks spent: 28
Child PID: 11, ticks spent: 15
</code></pre>
<p>The ticks for two different execution is likely to be different.</p>
<p>The one for stride should be like:</p>
<pre><code class="language-bash">$ ./test_scheduler 100 3 1024 512 256
Created child process with PID: 4 and tickets: 1024
Created child process with PID: 5 and tickets: 512
Created child process with PID: 6 and tickets: 256
Child PID: 4, ticks spent: 58
Child PID: 5, ticks spent: 29
Child PID: 6, ticks spent: 14
$ ./test_scheduler 100 3 1024 512 256
Created child process with PID: 8 and tickets: 1024
Created child process with PID: 9 and tickets: 512
Created child process with PID: 10 and tickets: 256
Child PID: 8, ticks spent: 58
Child PID: 9, ticks spent: 29
Child PID: 10, ticks spent: 14
$ 
</code></pre>
<p>The ticks for two different execution is likely to be same.</p>
<p>Try different process number, ticks and tickets and include a figure in you report like the one in stride scheduling paper. </p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
