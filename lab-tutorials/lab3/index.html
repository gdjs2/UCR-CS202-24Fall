<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Zhaoqi Xiao">
        <link rel="canonical" href="http://gdjs2.cn/UCR-CS202-24Fall/lab-tutorials/lab3/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Lab 3 - Kernel Thread - CS202 Advanced Operating System - Lab Session</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">CS202 Advanced Operating System - Lab Session</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">CS202 - Advanced Operating System - Lab Session - 24 Fall</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Lab tutorials</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../debug/" class="dropdown-item">Debugging Tips</a>
</li>
                                    
<li>
    <a href="../lab1/" class="dropdown-item">Lab 1 - System Call Implementation</a>
</li>
                                    
<li>
    <a href="../lab2/" class="dropdown-item">Lab 2 - Scheduler, Lottery and Stride</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Lab 3 - Kernel Thread</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../lab2/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" class="nav-link disabled">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#lab-3-kernel-thread" class="nav-link">Lab 3 - Kernel Thread</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#before-start" class="nav-link">Before Start:</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#pull-the-repo" class="nav-link">Pull the Repo</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#what-to-do" class="nav-link">What to do?</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#test" class="nav-link">Test</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#requirments" class="nav-link">Requirments:</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#grade" class="nav-link">Grade</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="lab-3-kernel-thread">Lab 3 - Kernel Thread</h1>
<h2 id="before-start">Before Start:</h2>
<p>Take a look at <a href="https://github.com/gdjs2/xv6-riscv-UCR-CS202-Fall24">our project repo</a>. We have a new <a href="https://github.com/gdjs2/xv6-riscv-UCR-CS202-Fall24/tree/kernel-thread-lab">kernel-thread-lab branch</a> published. In this lab, you need implement your work based on this branch. </p>
<p>Another very important thing is reading section 2.4 in <a href="https://pdos.csail.mit.edu/6.828/2023/xv6/book-riscv-rev3.pdf">xv6 book</a>, especially figure 2.3. And also, read necessary part, make sure you understand what Trapframe and Trapoline are. </p>
<h2 id="pull-the-repo">Pull the Repo</h2>
<p>Clone the repo to your local machine. </p>
<pre><code class="language-bash">$ git clone https://github.com/gdjs2/xv6-riscv-UCR-CS202-Fall24.git
</code></pre>
<p>Change directory and checkout to scheduler-lab branch. </p>
<pre><code class="language-bash">$ git checkout kernel-thread-lab
</code></pre>
<h2 id="what-to-do">What to do?</h2>
<p>I believe you have had a relatively good understanding to xv6. Therefore, I wouldn't provide a step-by-step instructions for this lab. However, you can check <code>TODO:</code> symbols in the code to find what you are expected to finish first. </p>
<p>The brief idea for this lab is implementing kernel thread support for xv6. You are not expected to write a new thread control block on your own, instead you can reuse <code>struct proc</code>. We have added two instance variables <code>thread_count</code> and <code>thread_id</code> in <code>struct proc</code>. They are enough for you to achieve thread allocation and memory management. However, you can/may need add more instance here to support complex management. </p>
<p>There are 4 <code>TODO:</code> symbols in <code>proc.c</code>.</p>
<ol>
<li><code>allocthread()</code>, which is similar to <code>allocproc()</code>.</li>
<li><code>freeproc()</code>, because we reuse <code>struct proc</code>, some modification should be added here to support thread. </li>
<li><code>proc_pagetable()</code>, you can reuse this function for allocate a pagetable for thread. You can also implement a seperate function. Both methods are accepted. </li>
<li><code>thread_freepagetable()</code>, the things should be freed for thread and process are different. Two major things are kernel stack and trapframe.</li>
</ol>
<p>In <code>trap.c</code>, you need to change <code>userret()</code> call. <strong>THIS PART IS DIFFICULT</strong>. You need to read some assembly code in <code>kernel/trampoline.S</code>. There are two functions in <code>trampoline.S</code>, one is for user space -&gt; kernel space, another is for kernel space -&gt; user space. Make sure you understand the modification in these two functions. </p>
<p>The last thing you need to do is implementing <code>thread.c</code>-the thread library in user space. You are required to implement another lock here, which is usable in memory access for threads. You are not required to implement a <code>join()</code> function, but you can if you want. </p>
<h2 id="test">Test</h2>
<p>After you finish your kernel thread implementation, there is one user space program <code>kt_test</code> provided to test your implementaion. This user space program only tests whether the threads share the same memory space and its functionality. We would grade your work mainly based on this program. </p>
<h2 id="requirments">Requirments:</h2>
<p>The kernel thread you implement is expected supporting:</p>
<ol>
<li>Share memory space</li>
<li>Memory safe</li>
</ol>
<p>The kernel thread you implement do <strong>NOT</strong> need:</p>
<ol>
<li>Share file descriptors.</li>
<li><code>exit()</code> function like traditional Linux. Traditionally, any thread calls <code>exit()</code> would terminate the <strong>PROCESS</strong>. However, in this lab, a thread calls <code>exit()</code> will only terminate itself and don't affect other processes/threads. </li>
</ol>
<p>Besides the modification indicated in the source file, you will still need add/modify some code to make your code <strong>MEMORY SAFE</strong> and <strong>EXIT CORRECTLY</strong>. Make sure you free all memory allocated by <code>*alloc()</code> and also, all <strong>MEMORY SIZE VARs</strong> are correct. </p>
<h2 id="grade">Grade</h2>
<p>Some critical grading points:</p>
<ol>
<li>We won't directly test <code>exit()</code> function, however you still need to clarify how you change your code to achieve the resource maintainance for threads. </li>
<li>Correct memory space shared among threads. </li>
<li>Correct lock implementation.</li>
<li>Memory safe</li>
<li>Explanation about trampoline and trapframe in detail.</li>
</ol></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
